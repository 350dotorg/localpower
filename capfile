ssh_options[:keys] = %w(~/.ec2/acp-ec2-pk.pem)  

set :deploy_to, "/scripts/www"
set :application, "rah"
set :user, "ubuntu"

# These things are not used at the moment
set :scm, :git
set :repository, "git@codebasehq-deploy:rah/rah/rah.git"
set :branch, "master"
# TODO replace awk command with ruby processing
set :revision, `git ls-remote origin #{branch} | awk 'BEGIN { FS = " " } ; { print $1 }'`.chomp.strip
set :username, `git config codebase.username`.chomp.strip
set :api_key, `git config codebase.apikey`.chomp.strip

role :app, "repowerathome.com"
# role :web, "repowerathome.com"
# role :db, "repowerathome.com", :primary => true

namespace :deploy do
    desc "Meta task that calls update and restart"
    task :default do
        update
        minify
        staticupload
        syncdb
        restart
        add_deployment_to_codebase
    end
    
    desc "Update Repo"
    task :update, :roles => :app do
        run "cd #{deploy_to}; git pull"
    end
    
    desc "Min JS and CSS files"
    task :minify, :roles => :app do
        `cd static/minify; ./minify.sh`
    end
    
    desc "Update static bucket"
    task :staticupload, :roles => :app do
        `python manage.py sync_media_s3 --gzip --force`
    end
    
    desc "Sync DB"
    task :syncdb, :roles => :app do
        run "cd #{deploy_to}; python manage.py syncdb"
    end
    
    desc "Restart Apache"
    task :restart, :roles => :app do
        sudo "/etc/init.d/apache2 restart"
    end
    
    desc "Tell Codebase about deployment"
    task :add_deployment_to_codebase do
      regex = /git\@(codebasehq-deploy):(.*)\/(.*)\/(.*)\.git/
      unless m = repository.match(regex)
        puts "  * \e[31mYour repository URL does not a match a valid CodebaseHQ Clone URL\e[0m"
      else
        url = "#{m[2]}.codebasehq.com"
        project = m[3]
        repository = m[4]

        puts "  * \e[44;33mAdding Deployment to your CodebaseHQ account\e[0m"
        puts "      -  Account......: #{url}"
        puts "      -  Username.....: #{username}"
        puts "      -  API Key......: #{api_key[0,10]}..."

        puts "      -  Project......: #{project}"
        puts "      -  Repository...: #{repository}"

        environment_to_send = begin
          env = (self.environment rescue self.rails_env).dup
          env.gsub!(/\W+/, ' ')
          env.strip!
          env.downcase!
          env.gsub!(/\ +/, '-')

          puts "      -  Environment..: #{env}" unless env.blank?

          env
        rescue
          ''
        end

        servers = roles.values.collect{|r| r.servers}.flatten.collect{|s| s.host}.uniq.join(', ') rescue ''

        puts "      -  Servers......: #{servers}"
        puts "      -  Revision.....: #{revision}"
        puts "      -  Branch.......: #{branch}"
        puts "      -  Environment..: #{environment_to_send}"

        xml = []
        xml << "<deployment>"
        xml << "<servers>#{servers}</servers>"
        xml << "<revision>#{revision}</revision>"
        xml << "<environment>#{environment_to_send}</environment>"
        xml << "<branch>#{branch}</branch>"
        xml << "</deployment>"

        require 'net/http'
        require 'uri'

        real_url = "http://#{url}/#{project}/#{repository}/deployments"
        puts "      -  URL..........: #{real_url}"

        url = URI.parse(real_url)

        req = Net::HTTP::Post.new(url.path)
        req.basic_auth(username, api_key)
        req.add_field('Content-type', 'application/xml')
        req.add_field('Accept', 'application/xml')
        res = Net::HTTP.new(url.host, url.port).start { |http| http.request(req, xml.join) }
        case res
        when Net::HTTPCreated then puts "  * \e[32mAdded deployment to Codebase\e[0m"
        else 
          puts "  * \e[31mSorry, your deployment was not logged in Codebase - please check your config above.\e[0m"
        end
      end
    end
end