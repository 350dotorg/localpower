proxy_set_header Host $host;
proxy_set_header X-Real-IP $remote_addr;
proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
proxy_set_header X-Url-Scheme $scheme;

gzip on;
gzip_comp_level 2;
gzip_proxied any;
gzip_types text/css application/x-javascript application/json;

# proxy to Apache listening on 127.0.0.1:8080
location / {
    proxy_pass http://app_servers;
}

location ^~ /media {
    rewrite ^/media(.*)$ http://s3.amazonaws.com/rah_django_admin_media$1 permanent;
}

location /robots.txt {
    rewrite ^(.*)$ http://_s3_domain$1;
}

location /favicon.ico {
    rewrite ^(.*)$ http://_s3_domain/images/theme/favicon.ico$1;
}

if ($request_uri ~* /youtube){
    rewrite ^.*/youtube/(.*)$ http://www.youtube.com/$1 permanent;
}

client_max_body_size 10M;
EOF

    cat > '/etc/nginx/sites-available/rah_base_http' << EOF
include sites-available/rah_base;
listen 80;
if ($request_uri ~* (/login|/password_change|/admin|/register|/user/edit|/validate)){
    rewrite (.*) https://$server_name$1 permanent;
}